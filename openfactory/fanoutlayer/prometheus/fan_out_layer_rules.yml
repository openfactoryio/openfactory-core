# ----------------------------------------------------------------------------------
# Prometheus rules for the OpenFactory OPCUA Fan-out Layer
#
# Purpose:
#   This file contains recording rules for metrics generated by the Fan-out Layer
#   components. Users can drop this file into their Prometheus setup
#   and reference it under the rule_files section.
#
# How to use:
#   In prometheus.yml, include it with rule_files:
#
#   rule_files:
#     - "fan_out_layer_rules.yml"
#
# Notes:
#   - Each group defines a set of related rules with a common evaluation interval.
#   - Labels defined in each rule (component, role) will be attached to the
#     resulting metrics and can be used for filtering or aggregating.
# ----------------------------------------------------------------------------------

groups:
  - name: fan_out_layer_forwarder
    interval: 15s
    rules:
      # Build info per forwarder
      - record: forwarder:build_info
        expr: fan_out_layer_forwarder_build_info
        labels:
          component: "fan_out_layer"
          role: "forwarder"

      # Message throughput per forwarder (messages/sec)
      - record: forwarder:messages_read_rate
        expr: rate(asset_forwarder_kafka_messages_consumed_total[1m])
        labels:
          component: "fan_out_layer"
          role: "forwarder"

      # Message throughput per NATS Cluster (messages/sec)
      - record: forwarder:messages_published_rate
        expr: rate(asset_forwarder_nats_messages_published_total[1m])
        labels:
          component: "fan_out_layer"
          role: "forwarder"

      # Queue size per forwarder
      - record: forwarder:queue_size_avg
        expr: sum(rate(asset_forwarder_queue_size_sum[1m])) by (forwarder)
              /
              sum(rate(asset_forwarder_queue_size_count[1m])) by (forwarder)
        labels:
          component: "fan_out_layer"
          role: "forwarder"

      # 95th percentile queue size per forwarder
      - record: forwarder:queue_size_p95
        expr: histogram_quantile(0.95, sum by (forwarder, le) (asset_forwarder_queue_size_bucket))
        labels:
          component: "fan_out_layer"
          role: "forwarder"

      # 99th percentile queue size per forwarder
      - record: forwarder:queue_size_p99
        expr: histogram_quantile(0.99, sum by (forwarder, le) (asset_forwarder_queue_size_bucket))
        labels:
          component: "fan_out_layer"
          role: "forwarder"

      # Queue time per forwarder
      - record: forwarder:queue_time_avg
        expr: sum(rate(asset_forwarder_queue_time_seconds_sum[1m])) by (forwarder)
              /
              sum(rate(asset_forwarder_queue_time_seconds_count[1m])) by (forwarder)
        labels:
          component: "fan_out_layer"
          role: "forwarder"

      # 95th percentile queue time per forwarder
      - record: forwarder:queue_time_p95
        expr: histogram_quantile(
                0.95,
                sum(rate(asset_forwarder_queue_time_seconds_bucket[1m])) by (forwarder, le)
              )
        labels:
          component: "fan_out_layer"
          role: "forwarder"

      # 99th percentile queue time per forwarder
      - record: forwarder:queue_time_p99
        expr: histogram_quantile(
                0.99,
                sum(rate(asset_forwarder_queue_time_seconds_bucket[1m])) by (forwarder, le)
              )
        labels:
          component: "fan_out_layer"
          role: "forwarder"

      # Processing latency in worker per forwarder
      - record: forwarder:worker_latency_avg
        expr: sum(rate(asset_forwarder_message_processing_latency_seconds_sum[1m])) by (forwarder)
              /
              sum(rate(asset_forwarder_message_processing_latency_seconds_count[1m])) by (forwarder)
        labels:
          component: "fan_out_layer"
          role: "forwarder"

      # 95th percentile processing latency in worker per forwarder
      - record: forwarder:worker_latency_p95
        expr: histogram_quantile(
                0.95,
                sum(rate(asset_forwarder_message_processing_latency_seconds_bucket[1m])) by (forwarder, le)
              )
        labels:
          component: "fan_out_layer"
          role: "forwarder"

      # 99th percentile processing latency in worker per forwarder
      - record: forwarder:worker_latency_p99
        expr: histogram_quantile(
                0.99,
                sum(rate(asset_forwarder_message_processing_latency_seconds_bucket[1m])) by (forwarder, le)
              )
        labels:
          component: "fan_out_layer"
          role: "forwarder"
